import { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import bridge from '@vkontakte/vk-bridge';
import './App.css';
import { api, helpers } from './services/api';

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ VK Storage
const generateDeviceId = async () => {
  try {
    const storedDeviceId = await getVKStorageItem('deviceId');
    if (storedDeviceId) {
      console.log('üì± –ü–æ–ª—É—á–µ–Ω deviceId –∏–∑ VK Storage:', storedDeviceId);
      return storedDeviceId;
    }
    
    const deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    await setVKStorageItem('deviceId', deviceId);
    console.log('üÜï –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π deviceId:', deviceId);
    return deviceId;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ deviceId:', error);
    return 'device_' + Math.random().toString(36).substr(2, 9);
  }
};

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ —Å —É—á–µ—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
const generateSessionId = (deviceId) => `session_${deviceId}_${Date.now()}`;

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å VK Storage
const setVKStorageItem = async (key, value) => {
  try {
    if (!key || typeof key !== 'string' || key.length > 100) return false;
    
    const keyRegex = /^[a-zA-Z_\-0-9]+$/;
    if (!keyRegex.test(key)) return false;
    
    const truncatedValue = typeof value === 'string' 
      ? value.substring(0, 4096) 
      : String(value).substring(0, 4096);
    
    const result = await bridge.send('VKWebAppStorageSet', {
      key: key,
      value: truncatedValue
    });
    
    return !!(result && result.result);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ VK Storage:', error);
    return false;
  }
};

const getVKStorageItem = async (key) => {
  try {
    if (!key || typeof key !== 'string') return null;
    
    const result = await bridge.send('VKWebAppStorageGet', {
      keys: [key]
    });
    
    if (result?.keys?.length > 0) {
      const item = result.keys.find(item => item.key === key);
      return item?.value || null;
    }
    
    return null;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑ VK Storage:', error);
    return null;
  }
};

const removeVKStorageItem = async (key) => {
  try {
    const result = await bridge.send('VKWebAppStorageSet', {
      key: key,
      value: ''
    });
    
    return !!(result && result.result);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ VK Storage:', error);
    return false;
  }
};

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏ –≤ VK Storage
const saveSessionState = async (state) => {
  try {
    const sessionData = {
      ...state,
      timestamp: Date.now()
    };
    
    const sessionString = JSON.stringify(sessionData);
    const saved = await setVKStorageItem('metro_session_state', sessionString);
    
    if (saved) {
      console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ VK Storage');
      return true;
    }
    
    return false;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
    return false;
  }
};

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏ –∏–∑ VK Storage
const loadSessionState = async () => {
  try {
    const sessionData = await getVKStorageItem('metro_session_state');
    
    if (sessionData) {
      const parsed = JSON.parse(sessionData);
      const now = Date.now();
      
      if (now - parsed.timestamp < 60 * 60 * 1000) {
        console.log('üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏');
        return parsed;
      } else {
        console.log('üïí –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —É—Å—Ç–∞—Ä–µ–ª–æ (–±–æ–ª—å—à–µ 1 —á–∞—Å–∞)');
        await clearSessionState();
      }
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
  }
  
  return null;
};

// –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏ –∏–∑ VK Storage
const clearSessionState = async () => {
  try {
    await removeVKStorageItem('metro_session_state');
    console.log('üßπ –û—á–∏—â–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏');
    return true;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
    return false;
  }
};

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ VK Storage
const saveAllSettingsToVKStorage = async (settings) => {
  try {
    console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ VK Storage');
    
    const savePromises = Object.entries(settings).map(async ([key, value]) => {
      if (value !== undefined && value !== null) {
        await setVKStorageItem(key, String(value));
      }
    });
    
    await Promise.all(savePromises);
    console.log('‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    return true;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
    return false;
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Ñ—Ñ–ª–∞–π–Ω
const setUserOffline = async (userId, sessionId, deviceId) => {
  if (!userId) return;
  
  try {
    console.log('üëã –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Ñ—Ñ–ª–∞–π–Ω:', userId);
    await api.updateUser(userId, { 
      online: false,
      last_seen: new Date().toISOString(),
      session_id: sessionId,
      device_id: deviceId
    });
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ—Ñ—Ñ–ª–∞–π–Ω–µ');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ñ—Ñ–ª–∞–π–Ω:', error);
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–Ω–ª–∞–π–Ω
const setUserOnline = async (userId, sessionId, deviceId) => {
  if (!userId) return;
  
  try {
    console.log('üëã –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–Ω–ª–∞–π–Ω:', userId);
    await api.updateUser(userId, { 
      online: true,
      last_seen: new Date().toISOString(),
      session_id: sessionId,
      device_id: deviceId
    });
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ–Ω–ª–∞–π–Ω–µ');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–Ω–ª–∞–π–Ω:', error);
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—Ç–∞–Ω—Ü–∏–π
const calculateStationsStats = (users, city) => {
  try {
    console.log('üìä –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—Ç–∞–Ω—Ü–∏–π –¥–ª—è –≥–æ—Ä–æ–¥–∞:', city);
    
    const stationStats = {};
    let total_connected = 0;
    let total_waiting = 0;
    
    const cityStations = helpers.stations[city] || [];
    
    cityStations.forEach(station => {
      stationStats[station] = {
        station: station,
        waiting: 0,
        connected: 0,
        totalUsers: 0
      };
    });
    
    users.forEach(user => {
      if (user.online !== true) return;
      
      if (user.is_waiting && !user.is_connected) {
        total_waiting++;
      } else if (user.is_connected && user.station) {
        total_connected++;
        
        if (stationStats[user.station]) {
          stationStats[user.station].connected++;
          stationStats[user.station].totalUsers++;
        }
      }
    });
    
    const stationStatsArray = Object.values(stationStats);
    
    console.log('üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞');
    
    return {
      stationStats: stationStatsArray,
      totalStats: {
        total_connected,
        total_waiting,
        total_users: total_connected + total_waiting
      }
    };
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    return {
      stationStats: [],
      totalStats: { total_connected: 0, total_waiting: 0, total_users: 0 }
    };
  }
};

// –î–µ–±–∞—É–Ω—Å —Ñ—É–Ω–∫—Ü–∏—è
const debounce = (func, wait) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};

export const App = () => {
  // –°–æ—Å—Ç–æ—è–Ω–∏—è
  const [fetchedUser, setUser] = useState();
  const [appState, setAppState] = useState('active');
  const [currentScreen, setCurrentScreen] = useState('setup');
  const [selectedCity, setSelectedCity] = useState('spb');
  const [selectedGender, setSelectedGender] = useState('male');
  const [selectedPosition, setSelectedPosition] = useState('');
  const [selectedMood, setSelectedMood] = useState('');
  const [wagonNumber, setWagonNumber] = useState('');
  const [clothingColor, setClothingColor] = useState('');
  const [nickname, setNickname] = useState('');
  const [timerActive, setTimerActive] = useState(false);
  const [selectedMinutes, setSelectedMinutes] = useState(5);
  const [currentSelectedStation, setCurrentSelectedStation] = useState(null);
  const [currentGroup, setCurrentGroup] = useState(null);
  const [stationsData, setStationsData] = useState({ 
    stationStats: [], 
    totalStats: { total_connected: 0, total_waiting: 0, total_users: 0 } 
  });
  const [groupMembers, setGroupMembers] = useState([]);
  const [allUsers, setAllUsers] = useState([]);
  const [usersCache, setUsersCache] = useState(null);
  const [cacheTimestamp, setCacheTimestamp] = useState(0);
  const [lastPingTime, setLastPingTime] = useState(0);
  const [isLoading, setIsLoading] = useState(false);
  const [isOnline, setIsOnline] = useState(true);
  const [deviceId, setDeviceId] = useState('');
  const [isSessionRestoring, setIsSessionRestoring] = useState(false);
  const [nicknameError, setNicknameError] = useState(false);
  const [clothingColorError, setClothingColorError] = useState(false);
  const [stationError, setStationError] = useState(false);
  const [restoreAttempted, setRestoreAttempted] = useState(false);
  const [isColdStart, setIsColdStart] = useState(true);
  const [notificationText, setNotificationText] = useState('');
  
  const CACHE_DURATION = 60000;
  const PING_INTERVAL = 120000;

  // –†–µ—Ñ—ã
  const userIdRef = useRef(null);
  const globalRefreshIntervalRef = useRef(null);
  const sessionIdRef = useRef('');
  const vkUserIdRef = useRef(null);
  const nicknameInputRef = useRef(null);
  const clothingColorInputRef = useRef(null);
  const metroMapRef = useRef(null);
  const isInitialMountRef = useRef(true);
  const sessionRestoreInProgressRef = useRef(false);
  const appCloseHandlerRef = useRef(null);
  const backgroundPingIntervalRef = useRef(null);
  const isAppClosingRef = useRef(false);
  const lastApiCallRef = useRef(0);
  const apiCallCooldownRef = useRef(3000);
  const isInBackgroundRef = useRef(false);
  const pingTimeoutRef = useRef(null);
  const saveSettingsTimeoutRef = useRef(null);
  const updateStatusTimeoutRef = useRef(null);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤
  const safeApiCall = useCallback(async (apiFunction, ...args) => {
    const now = Date.now();
    const timeSinceLastCall = now - lastApiCallRef.current;
    
    if (timeSinceLastCall < apiCallCooldownRef.current) {
      const waitTime = apiCallCooldownRef.current - timeSinceLastCall;
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }
    
    lastApiCallRef.current = Date.now();
    
    let lastError;
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        return await apiFunction(...args);
      } catch (error) {
        lastError = error;
        console.warn(`‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ ${attempt}/3 –Ω–µ —É–¥–∞–ª–∞—Å—å:`, error.message);
        
        if (attempt < 3) {
          await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
        }
      }
    }
    
    throw lastError || new Error('API –≤—ã–∑–æ–≤ –Ω–µ —É–¥–∞–ª—Å—è –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫');
  }, []);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–∏–Ω–≥–∞
  const improvedPingActivity = useCallback(async () => {
    if (!userIdRef.current) return false;
    
    const now = Date.now();
    if (now - lastPingTime < 30000) return false;
    
    try {
      const currentDeviceId = await generateDeviceId();
      
      const updateData = { 
        online: true,
        is_connected: currentScreen === 'joined',
        session_id: sessionIdRef.current,
        device_id: currentDeviceId,
        last_seen: new Date().toISOString(),
        ...(currentScreen === 'joined' && currentGroup && { 
          station: currentGroup.station 
        })
      };
      
      await safeApiCall(api.pingActivity, userIdRef.current, updateData);
      setLastPingTime(now);
      
      if (currentScreen === 'joined') {
        await loadGroupMembers();
      }
      
      return true;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);
      return false;
    }
  }, [currentScreen, currentGroup, lastPingTime, safeApiCall]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  const loadStationsMap = useCallback(async () => {
    try {
      console.log('üó∫Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—Ç–∞–Ω—Ü–∏–π –¥–ª—è –≥–æ—Ä–æ–¥–∞:', selectedCity);
      
      const users = await safeApiCall(api.getUsers);
      const stats = calculateStationsStats(users, selectedCity);
      
      setStationsData(stats);
      
      const activeUsers = users.filter(user => user.online === true);
      setAllUsers(activeUsers);
      setUsersCache(activeUsers);
      setCacheTimestamp(Date.now());
      
      console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
      return stats;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã —Å—Ç–∞–Ω—Ü–∏–π:', error);
      const emptyStats = {
        stationStats: [],
        totalStats: { total_connected: 0, total_waiting: 0, total_users: 0 }
      };
      setStationsData(emptyStats);
      return emptyStats;
    }
  }, [selectedCity, safeApiCall]);

  const loadGroupMembers = useCallback(async (station = null) => {
    const targetStation = station || (currentGroup ? currentGroup.station : null);
    
    if (!targetStation) {
      setGroupMembers([]);
      return;
    }
    
    try {
      const users = await safeApiCall(api.getUsers);
      const groupUsers = users.filter(user => {
        const isOnStation = user.station === targetStation && user.is_connected === true;
        
        if (userIdRef.current && user.id === userIdRef.current) {
          return isOnStation && user.online === true;
        }
        
        return isOnStation && user.online === true;
      });
      
      console.log(`üë• –ó–∞–≥—Ä—É–∂–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ ${targetStation}:`, groupUsers.length);
      setGroupMembers(groupUsers);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã:', error);
      setGroupMembers([]);
    }
  }, [currentGroup, safeApiCall]);

  const loadRequests = useCallback(async (forceRefresh = false) => {
    const now = Date.now();
    
    if (!forceRefresh && usersCache && (now - cacheTimestamp) < CACHE_DURATION) {
      setAllUsers(usersCache);
      return usersCache;
    }
    
    try {
      const users = await safeApiCall(api.getUsers);
      const activeUsers = users.filter(user => user.online === true);
      setAllUsers(activeUsers);
      setUsersCache(activeUsers);
      setCacheTimestamp(now);
      return activeUsers;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
      return usersCache || [];
    }
  }, [usersCache, cacheTimestamp, safeApiCall]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const handleNicknameChange = useCallback((e) => {
    setNickname(e.target.value);
    if (nicknameError) setNicknameError(false);
  }, [nicknameError]);

  const handleClothingColorChange = useCallback((e) => {
    setClothingColor(e.target.value);
    if (clothingColorError) setClothingColorError(false);
  }, [clothingColorError]);

  const handleStationSelect = useCallback((stationName) => {
    setCurrentSelectedStation(stationName);
    if (stationError) setStationError(false);
  }, [stationError]);

  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  const validateNickname = useCallback(() => {
    const trimmedNickname = nickname.trim();
    if (!trimmedNickname) {
      setNicknameError(true);
      return false;
    }
    setNicknameError(false);
    return true;
  }, [nickname]);

  const validateClothingColor = useCallback(() => {
    const trimmedColor = clothingColor.trim();
    if (!trimmedColor) {
      setClothingColorError(true);
      return false;
    }
    setClothingColorError(false);
    return true;
  }, [clothingColor]);

  const validateStation = useCallback(() => {
    if (!currentSelectedStation) {
      setStationError(true);
      return false;
    }
    setStationError(false);
    return true;
  }, [currentSelectedStation]);

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const generateUserStatus = useCallback(() => {
    const positionPart = selectedPosition ? selectedPosition : '';
    const moodPart = selectedMood ? selectedMood : '';
    
    if (positionPart && moodPart) {
      return `${positionPart} | ${moodPart}`;
    } else if (positionPart || moodPart) {
      return positionPart || moodPart;
    } else {
      return '–û–∂–∏–¥–∞–Ω–∏–µ';
    }
  }, [selectedPosition, selectedMood]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–µ–±–∞—É–Ω—Å–æ–º
  const debouncedUpdateUserState = useCallback(
    debounce(async () => {
      if (!userIdRef.current) return;
      
      try {
        const newStatus = generateUserStatus();
        const currentDeviceId = await generateDeviceId();
        
        await safeApiCall(api.updateUser, userIdRef.current, { 
          status: newStatus,
          position: selectedPosition,
          mood: selectedMood,
          session_id: sessionIdRef.current,
          device_id: currentDeviceId,
          last_seen: new Date().toISOString()
        });
        
        setGroupMembers(prevMembers => 
          prevMembers.map(member => 
            member.id === userIdRef.current 
              ? { 
                  ...member, 
                  status: newStatus,
                  position: selectedPosition,
                  mood: selectedMood
                }
              : member
          )
        );
        
        await loadGroupMembers();
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
      }
    }, 1000),
    [selectedPosition, selectedMood, safeApiCall, loadGroupMembers, generateUserStatus]
  );

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É –æ–∂–∏–¥–∞–Ω–∏—è
  const handleEnterWaitingRoom = useCallback(async () => {
    if (!validateNickname()) return;
    
    setIsLoading(true);

    try {
      const trimmedNickname = nickname.trim();
      const currentDeviceId = await generateDeviceId();
      const newSessionId = generateSessionId(currentDeviceId);
      
      console.log('üÜï –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é');
      
      const userData = {
        name: trimmedNickname,
        station: '',
        wagon: wagonNumber || '',
        color: clothingColor || '',
        colorCode: helpers.getRandomColor(),
        status: '–í —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è',
        timer: "00:00",
        online: true,
        city: selectedCity,
        gender: selectedGender,
        position: '',
        mood: '',
        is_waiting: true,
        is_connected: false,
        session_id: newSessionId,
        device_id: currentDeviceId,
        vk_user_id: vkUserIdRef.current,
        last_seen: new Date().toISOString()
      };

      const createdUser = await safeApiCall(api.createUser, userData);
      
      if (createdUser) {
        userIdRef.current = createdUser.id;
        sessionIdRef.current = newSessionId;
        console.log('‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è:', createdUser.id);
        
        await saveSessionState({
          userId: userIdRef.current,
          nickname: trimmedNickname,
          selectedCity,
          selectedGender,
          clothingColor,
          wagonNumber,
          currentSelectedStation,
          currentScreen: 'waiting',
          timestamp: Date.now()
        });
        
        setCurrentScreen('waiting');
        await Promise.all([loadStationsMap(), loadRequests()]);
      }
    } catch (error) {
      console.error('‚ùå –û–®–ò–ë–ö–ê –≤ handleEnterWaitingRoom:', error);
    } finally {
      setIsLoading(false);
    }
  }, [nickname, wagonNumber, clothingColor, selectedCity, selectedGender, validateNickname, safeApiCall, loadStationsMap, loadRequests]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞–Ω—Ü–∏–∏
  const handleConfirmStation = useCallback(async () => {
    if (!validateClothingColor() || !nickname || !validateStation()) return;
    
    if (!userIdRef.current) return;

    setIsLoading(true);
    try {
      const currentDeviceId = await generateDeviceId();
      
      await safeApiCall(api.updateUser, userIdRef.current, {
        station: currentSelectedStation,
        wagon: wagonNumber,
        color: clothingColor.trim(),
        name: nickname.trim(),
        is_waiting: false,
        is_connected: true,
        online: true,
        session_id: sessionIdRef.current,
        device_id: currentDeviceId,
        last_seen: new Date().toISOString(),
        status: '–í—ã–±—Ä–∞–ª —Å—Ç–∞–Ω—Ü–∏—é: ' + currentSelectedStation
      });

      const users = await safeApiCall(api.getUsers);
      const stationUsers = users.filter(user => 
        user.station === currentSelectedStation && 
        user.is_connected === true &&
        user.online === true
      );
      
      const groupData = {
        station: currentSelectedStation,
        users: stationUsers
      };
      
      setCurrentGroup(groupData);
      setCurrentScreen('joined');
      
      await saveSessionState({
        userId: userIdRef.current,
        nickname: nickname.trim(),
        selectedCity,
        selectedGender,
        clothingColor: clothingColor.trim(),
        wagonNumber,
        currentSelectedStation,
        currentScreen: 'joined',
        timestamp: Date.now()
      });
      
      setTimeout(() => {
        loadGroupMembers(currentSelectedStation);
        loadRequests(true);
      }, 100);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:', error);
    } finally {
      setIsLoading(false);
    }
  }, [validateClothingColor, nickname, validateStation, currentSelectedStation, wagonNumber, clothingColor, selectedCity, selectedGender, safeApiCall, loadGroupMembers, loadRequests]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ –≥—Ä—É–ø–ø—ã
  const handleLeaveGroup = useCallback(async () => {
    if (userIdRef.current) {
      try {
        const currentDeviceId = await generateDeviceId();
        
        await safeApiCall(api.updateUser, userIdRef.current, { 
          status: '–û–∂–∏–¥–∞–Ω–∏–µ',
          is_waiting: true,
          is_connected: false,
          station: '',
          session_id: sessionIdRef.current,
          device_id: currentDeviceId,
          last_seen: new Date().toISOString()
        });
        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ –≥—Ä—É–ø–ø—ã');
        
        await saveSessionState({
          userId: userIdRef.current,
          nickname,
          selectedCity,
          selectedGender,
          clothingColor,
          wagonNumber,
          currentSelectedStation: null,
          currentScreen: 'waiting',
          timestamp: Date.now()
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      }
    }
    
    setCurrentGroup(null);
    setCurrentScreen('waiting');
    setSelectedPosition('');
    setSelectedMood('');
  }, [nickname, selectedCity, selectedGender, clothingColor, wagonNumber, safeApiCall]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞
  const handleCitySelect = useCallback((city) => setSelectedCity(city), []);
  const handleGenderSelect = useCallback((gender) => setSelectedGender(gender), []);
  const handleTimerSelect = useCallback((minutes) => setSelectedMinutes(minutes), []);

  const handlePositionSelect = useCallback((position) => {
    setSelectedPosition(position);
    debouncedUpdateUserState();
  }, [debouncedUpdateUserState]);

  const handleMoodSelect = useCallback((mood) => {
    setSelectedMood(mood);
    debouncedUpdateUserState();
  }, [debouncedUpdateUserState]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç—ã —Å—Ç–∞–Ω—Ü–∏–π —Å –º–µ–º–æ–∏–∑–∞—Ü–∏–µ–π
  const renderStationsMap = useCallback(() => {
    const { stationStats } = stationsData;
    
    if (!stationStats || stationStats.length === 0) {
      return (
        <div className="loading" style={{ textAlign: 'center', padding: '20px' }}>
          <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã —Å—Ç–∞–Ω—Ü–∏–π...</div>
          <small style={{ color: '#666' }}>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∞–Ω—Ü–∏—è—Ö</small>
        </div>
      );
    }
    
    const cityStations = helpers.stations[selectedCity] || [];
    const stationsMap = {};
    stationStats.forEach(station => {
      stationsMap[station.station] = station;
    });
    
    return cityStations.map(stationName => {
      const stationData = stationsMap[stationName];
      let stationClass = 'empty';
      
      if (stationData) {
        const waitingCount = stationData.waiting || 0;
        const connectedCount = stationData.connected || 0;
        
        if (connectedCount > 0) {
          stationClass = 'connected';
        } else if (waitingCount > 0) {
          stationClass = 'waiting';
        }
      }
      
      const totalCount = stationData ? (stationData.waiting || 0) + (stationData.connected || 0) : 0;
      const isSelected = currentSelectedStation === stationName;
      
      return (
        <div 
          key={stationName}
          className={`station-map-item ${stationClass} ${isSelected ? 'selected' : ''}`}
          onClick={() => handleStationSelect(stationName)}
        >
          <div className="station-name">{stationName}</div>
          {totalCount > 0 ? (
            <div className="station-counts">
              {stationData.waiting > 0 && <span className="station-count count-waiting">{stationData.waiting}‚è≥</span>}
              {stationData.connected > 0 && <span className="station-count count-connected">{stationData.connected}‚úÖ</span>}
            </div>
          ) : (
            <div style={{fontSize: '10px', color: '#666'}}>–ü—É—Å—Ç–æ</div>
          )}
        </div>
      );
    });
  }, [stationsData, selectedCity, currentSelectedStation, handleStationSelect]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
  const renderGroupMembers = useCallback(() => {
    if (groupMembers.length === 0) {
      return <div className="no-requests">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞ —ç—Ç–æ–π —Å—Ç–∞–Ω—Ü–∏–∏</div>;
    }
    
    return groupMembers.map(user => {
      const isCurrentUser = userIdRef.current && user.id === userIdRef.current;
      
      let stateDetails = '';
      if (user.position || user.mood) {
        if (user.position) stateDetails += `<span class="state-highlight">${user.position}</span>`;
        if (user.mood) {
          if (user.position) stateDetails += ' ‚Ä¢ ';
          stateDetails += `<span class="state-highlight">${user.mood}</span>`;
        }
      }
      
      let additionalInfo = '';
      if (user.color) additionalInfo += `üé® ${user.color}`;
      if (user.wagon && user.wagon !== '' && user.wagon !== '–ù–µ —É–∫–∞–∑–∞–Ω') {
        if (additionalInfo) additionalInfo += ' ‚Ä¢ ';
        additionalInfo += `üöá –í–∞–≥–æ–Ω ${user.wagon}`;
      }
      
      return (
        <div key={user.id} className={`user-state-display ${isCurrentUser ? 'current-user' : ''}`}>
          <div className="user-avatar" style={{background: user.color_code || '#007bff'}}>
            {user.name.charAt(0)}
          </div>
          <div className="user-state-info">
            <div className="user-state-name">{user.name} {isCurrentUser ? '(–í—ã)' : ''}</div>
            <div className="user-state-details">
              <div dangerouslySetInnerHTML={{ __html: stateDetails }} />
              {additionalInfo && (
                <div style={{marginTop: '5px', fontSize: '12px', color: '#666'}}>
                  {additionalInfo}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    });
  }, [groupMembers]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  const showSetup = useCallback(() => setCurrentScreen('setup'), []);
  const showWaitingRoom = useCallback(() => {
    if (!userIdRef.current) {
      if (!validateNickname()) return;
      return;
    }
    setCurrentScreen('waiting');
  }, [validateNickname]);

  const showJoinedRoom = useCallback(() => {
    if (!currentGroup) return;
    setCurrentScreen('joined');
  }, [currentGroup]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π useEffect –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
  useEffect(() => {
    if (saveSettingsTimeoutRef.current) {
      clearTimeout(saveSettingsTimeoutRef.current);
    }
    
    saveSettingsTimeoutRef.current = setTimeout(async () => {
      try {
        const settings = {
          selectedCity,
          selectedGender,
          selectedPosition,
          selectedMood,
          selectedStation: currentSelectedStation,
          selectedTimerMinutes: selectedMinutes,
          nickname,
          clothingColor,
          wagonNumber,
          currentScreen
        };
        
        await saveAllSettingsToVKStorage(settings);
        
        if (userIdRef.current && !isColdStart) {
          const sessionState = {
            userId: userIdRef.current,
            nickname,
            selectedCity,
            selectedGender,
            clothingColor,
            wagonNumber,
            currentSelectedStation,
            currentScreen,
            timestamp: Date.now()
          };
          
          await saveSessionState(sessionState);
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
      }
    }, 3000);
    
    return () => {
      if (saveSettingsTimeoutRef.current) {
        clearTimeout(saveSettingsTimeoutRef.current);
      }
    };
  }, [
    selectedCity, selectedGender, selectedPosition, selectedMood,
    currentSelectedStation, selectedMinutes, nickname, clothingColor,
    wagonNumber, currentScreen, currentGroup, isColdStart
  ]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π useEffect –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
  useEffect(() => {
    if (updateStatusTimeoutRef.current) {
      clearTimeout(updateStatusTimeoutRef.current);
    }
    
    if (userIdRef.current && (selectedPosition || selectedMood)) {
      updateStatusTimeoutRef.current = setTimeout(() => {
        debouncedUpdateUserState();
      }, 5000);
    }
    
    return () => {
      if (updateStatusTimeoutRef.current) {
        clearTimeout(updateStatusTimeoutRef.current);
      }
    };
  }, [selectedPosition, selectedMood, debouncedUpdateUserState]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π useEffect –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω
  useEffect(() => {
    const handleOnline = async () => {
      console.log('üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      setIsOnline(true);
      
      if (userIdRef.current && (currentScreen === 'joined' || currentScreen === 'waiting')) {
        try {
          const currentDeviceId = await generateDeviceId();
          await setUserOnline(userIdRef.current, sessionIdRef.current, currentDeviceId);
          
          if (currentScreen === 'joined') {
            await loadGroupMembers();
            await loadRequests(true);
          } else if (currentScreen === 'waiting') {
            await loadStationsMap();
            await loadRequests();
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
        }
      }
    };
    
    const handleOffline = () => {
      console.log('üåê –ü–æ—Ç–µ—Ä—è–Ω–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
      setIsOnline(false);
      setNotificationText('‚ö†Ô∏è –ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º');
    };
    
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, [currentScreen, currentGroup, loadStationsMap, loadRequests, loadGroupMembers]);

  // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  useEffect(() => {
    console.log('‚úÖ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç App –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    const initializeDevice = async () => {
      try {
        const generatedDeviceId = await generateDeviceId();
        setDeviceId(generatedDeviceId);
        console.log('üì± –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', generatedDeviceId);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', error);
        const fallbackDeviceId = 'device_' + Math.random().toString(36).substr(2, 9);
        setDeviceId(fallbackDeviceId);
      }
    };
    
    initializeDevice();
    
    bridge.send("VKWebAppInit")
      .then((data) => {
        if (data.result) {
          console.log('‚úÖ VK Bridge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }
      })
      .catch((error) => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ VK Bridge:', error);
      });

    const handleVisibilityChange = () => {
      if (document.hidden) {
        console.log('üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—à–ª–æ –≤ —Ñ–æ–Ω');
        isInBackgroundRef.current = true;
        setAppState('background');
      } else {
        console.log('üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ');
        isInBackgroundRef.current = false;
        setAppState('active');
        if (userIdRef.current) {
          improvedPingActivity();
        }
      }
    };

    const handleBeforeUnload = async (event) => {
      console.log('‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω');
      isAppClosingRef.current = true;
      
      if (pingTimeoutRef.current) clearTimeout(pingTimeoutRef.current);
      if (backgroundPingIntervalRef.current) clearInterval(backgroundPingIntervalRef.current);
      
      if (userIdRef.current) {
        try {
          const currentDeviceId = await generateDeviceId();
          await setUserOffline(userIdRef.current, sessionIdRef.current, currentDeviceId);
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Ñ—Ñ–ª–∞–π–Ω:', error);
        }
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    window.addEventListener('beforeunload', handleBeforeUnload);

    const bridgeUnsubscribe = bridge.subscribe((event) => {
      if (!event.detail) return;
      
      const { type, data } = event.detail;
      
      switch (type) {
        case 'VKWebAppUpdateConfig':
          const schemeAttribute = document.createAttribute('scheme');
          schemeAttribute.value = data.scheme ? data.scheme : 'client_light';
          document.body.attributes.setNamedItem(schemeAttribute);
          break;
        case 'VKWebAppViewHide':
          isInBackgroundRef.current = true;
          setAppState('background');
          break;
        case 'VKWebAppViewRestore':
          isInBackgroundRef.current = false;
          setAppState('active');
          if (userIdRef.current) improvedPingActivity();
          break;
        default:
          break;
      }
    });

    async function fetchUserData() {
      try {
        const user = await bridge.send('VKWebAppGetUserInfo');
        setUser(user);
        vkUserIdRef.current = user.id;
        console.log('üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è VK –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', user.id);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      }
    }
    
    fetchUserData();
    
    const restoreSession = async () => {
      if (sessionRestoreInProgressRef.current) return;
      sessionRestoreInProgressRef.current = true;
      setIsSessionRestoring(true);
      setRestoreAttempted(true);
      
      try {
        console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏...');
        const savedState = await loadSessionState();
        
        if (savedState) {
          console.log('üìÇ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏');
          
          setNickname(savedState.nickname || '');
          setSelectedCity(savedState.selectedCity || 'spb');
          setSelectedGender(savedState.selectedGender || 'male');
          setClothingColor(savedState.clothingColor || '');
          setWagonNumber(savedState.wagonNumber || '');
          setCurrentSelectedStation(savedState.currentSelectedStation || null);
          
          const currentDeviceId = await generateDeviceId();
          const users = await safeApiCall(api.getUsers);
          
          let serverSession = null;
          if (savedState.userId) {
            serverSession = users.find(user => user.id === savedState.userId);
          }
          
          if (!serverSession && savedState.nickname) {
            serverSession = users.find(user => 
              user.device_id === currentDeviceId && 
              user.name === savedState.nickname &&
              user.online === true
            );
          }
          
          if (!serverSession) {
            serverSession = users.find(user => 
              user.device_id === currentDeviceId &&
              user.online === true
            );
          }
          
          if (serverSession) {
            userIdRef.current = serverSession.id;
            const newSessionId = generateSessionId(currentDeviceId);
            sessionIdRef.current = newSessionId;
            
            await setUserOnline(serverSession.id, newSessionId, currentDeviceId);
            
            setSelectedPosition(serverSession.position || '');
            setSelectedMood(serverSession.mood || '');
            
            if (serverSession.is_connected && serverSession.station) {
              setCurrentScreen('joined');
              setCurrentGroup({ station: serverSession.station, users: [] });
              
              setTimeout(() => {
                loadGroupMembers(serverSession.station);
                loadRequests();
              }, 300);
              
            } else if (serverSession.is_waiting || !serverSession.is_connected) {
              setCurrentScreen('waiting');
              loadStationsMap();
              loadRequests();
            } else {
              setCurrentScreen('setup');
            }
            
            await saveSessionState({
              userId: serverSession.id,
              nickname: serverSession.name || savedState.nickname,
              selectedCity: serverSession.city || savedState.selectedCity || 'spb',
              selectedGender: serverSession.gender || savedState.selectedGender || 'male',
              clothingColor: serverSession.color || savedState.clothingColor || '',
              wagonNumber: serverSession.wagon || savedState.wagonNumber || '',
              currentSelectedStation: serverSession.station || savedState.currentSelectedStation,
              currentScreen: serverSession.is_connected ? 'joined' : 'waiting',
              timestamp: Date.now()
            });
            
          } else {
            console.log('‚ùå –°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ');
            setCurrentScreen('setup');
            await clearSessionState();
          }
        } else {
          console.log('üÜï –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –Ω–∞—á–∏–Ω–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞');
          await checkAndRestoreSession();
        }
      } catch (error) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
        setCurrentScreen('setup');
      } finally {
        setIsSessionRestoring(false);
        sessionRestoreInProgressRef.current = false;
        setIsColdStart(false);
      }
    };
    
    const checkAndRestoreSession = async () => {
      try {
        const currentDeviceId = await generateDeviceId();
        console.log('üîç –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', currentDeviceId);
        
        const users = await safeApiCall(api.getUsers);
        const deviceSessions = users.filter(user => 
          user.device_id === currentDeviceId &&
          user.online === true
        );
        
        console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π:`, deviceSessions.length);
        
        if (deviceSessions.length === 0) {
          console.log('üÜï –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –¥–ª—è —ç—Ç–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
          setCurrentScreen('setup');
          return;
        }
        
        deviceSessions.sort((a, b) => {
          const timeA = a.last_seen ? new Date(a.last_seen).getTime() : 0;
          const timeB = b.last_seen ? new Date(b.last_seen).getTime() : 0;
          return timeB - timeA;
        });
        
        const latestSession = deviceSessions[0];
        console.log('üéØ –°–∞–º–∞—è —Å–≤–µ–∂–∞—è —Å–µ—Å—Å–∏—è:', latestSession.id, latestSession.name);
        
        userIdRef.current = latestSession.id;
        const newSessionId = generateSessionId(currentDeviceId);
        sessionIdRef.current = newSessionId;
        
        setNickname(latestSession.name || '');
        setSelectedCity(latestSession.city || 'spb');
        setSelectedGender(latestSession.gender || 'male');
        setSelectedPosition(latestSession.position || '');
        setSelectedMood(latestSession.mood || '');
        setClothingColor(latestSession.color || '');
        setWagonNumber(latestSession.wagon || '');
        
        await setUserOnline(latestSession.id, newSessionId, currentDeviceId);
        
        await saveSessionState({
          userId: latestSession.id,
          nickname: latestSession.name,
          selectedCity: latestSession.city,
          selectedGender: latestSession.gender,
          clothingColor: latestSession.color,
          wagonNumber: latestSession.wagon,
          currentSelectedStation: latestSession.station,
          currentScreen: latestSession.is_connected ? 'joined' : 'waiting',
          timestamp: Date.now()
        });
        
        console.log('üîÑ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞');
        
        if (latestSession.is_connected && latestSession.station) {
          setCurrentSelectedStation(latestSession.station);
          setCurrentScreen('joined');
          setCurrentGroup({ station: latestSession.station, users: [] });
          setTimeout(() => {
            loadGroupMembers(latestSession.station);
            loadRequests();
          }, 100);
        } else {
          setCurrentScreen('waiting');
          loadStationsMap();
          loadRequests();
        }
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
        setCurrentScreen('setup');
      }
    };
    
    restoreSession();
    
    const startPeriodicPing = () => {
      return setInterval(async () => {
        if (userIdRef.current && !isInBackgroundRef.current) {
          await improvedPingActivity();
        }
      }, PING_INTERVAL);
    };

    const pingInterval = startPeriodicPing();

    return () => {
      console.log('üßπ –û—á–∏—Å—Ç–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞');
      
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('beforeunload', handleBeforeUnload);
      
      if (bridgeUnsubscribe) bridgeUnsubscribe();
      
      if (pingTimeoutRef.current) clearTimeout(pingTimeoutRef.current);
      if (pingInterval) clearInterval(pingInterval);
      if (backgroundPingIntervalRef.current) clearInterval(backgroundPingIntervalRef.current);
      if (globalRefreshIntervalRef.current) clearInterval(globalRefreshIntervalRef.current);
      if (saveSettingsTimeoutRef.current) clearTimeout(saveSettingsTimeoutRef.current);
      if (updateStatusTimeoutRef.current) clearTimeout(updateStatusTimeoutRef.current);
      
      if (isAppClosingRef.current && userIdRef.current) {
        const currentDeviceId = deviceId || 'device_' + Math.random().toString(36).substr(2, 9);
        setUserOffline(userIdRef.current, sessionIdRef.current, currentDeviceId);
      }
    };
  }, []);

  // –†–µ–Ω–¥–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  return (
    <div className="app-container">
      {notificationText && (
        <div className="notification" style={{
          position: 'fixed',
          top: '10px',
          left: '50%',
          transform: 'translateX(-50%)',
          backgroundColor: '#333',
          color: 'white',
          padding: '10px 20px',
          borderRadius: '5px',
          zIndex: 1000,
          boxShadow: '0 2px 10px rgba(0,0,0,0.3)'
        }}>
          {notificationText}
          <button 
            onClick={() => setNotificationText('')}
            style={{
              background: 'none',
              border: 'none',
              color: 'white',
              marginLeft: '10px',
              cursor: 'pointer'
            }}
          >
            √ó
          </button>
        </div>
      )}
      
      {!isOnline && (
        <div className="offline-indicator">
          ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º (–Ω–æ –≤—ã –æ—Å—Ç–∞–µ—Ç–µ—Å—å –æ–Ω–ª–∞–π–Ω)
        </div>
      )}
      
      {(isLoading || isSessionRestoring) && (
        <div className="loader-card">
          <h3 className="loader-title"></h3>
          <div className="loader-box">
            <div className="loader-1" id="neuromorphic-loader">
              <div className="neuromorphic-circle"></div>
            </div>
            {isSessionRestoring && (
              <div style={{textAlign: 'center', marginTop: '10px'}}>
                –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏...
              </div>
            )}
          </div>
        </div>
      )}
      
      <div className="container">
        <header>
          <div className="header-main">
            <div className="header-title">
              <h1>–ú–µ—Ç—Ä–æ—Å</h1>
              <div className="subtitle">–í—Å—Ç—Ä–µ—á–∞–π –ø–æ–ø—É—Ç—á–∏–∫–∞üöâ‚úî</div>
            </div>
            <div className="header-icons">
              <div className="metro-icon">üöá</div>
            </div>
          </div>
        </header>
        
        <div className="content">
          {currentScreen === 'setup' && (
            <div id="setup-screen" className="screen active">
              <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
              <div className="navigation-buttons">
                <button className="nav-btn active">1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞</button>
                <button className="nav-btn" onClick={showWaitingRoom}>2. –í—ã–±–æ—Ä —Å—Ç–∞–Ω—Ü–∏–∏</button>
                <button className="nav-btn" onClick={showJoinedRoom}>3. –ö–æ–º–Ω–∞—Ç–∞ —Å—Ç–∞–Ω—Ü–∏–∏</button>
              </div>
              <p>–£–∫–∞–∂–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥ –∏ –ø–æ–ª</p>
              
              <div className="form-group">
                <label htmlFor="nickname-input" style={{ color: nicknameError ? '#ff4444' : '' }}>
                  –£–∫–∞–∂–∏—Ç–µ –í–∞—à –Ω–∏–∫–Ω–µ–π–º *
                  {nicknameError && (
                    <span style={{ color: '#ff4444', marginLeft: '5px', fontSize: '12px' }}>
                      (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
                    </span>
                  )}
                </label>
                <input 
                  ref={nicknameInputRef}
                  type="text" 
                  id="nickname-input" 
                  placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è" 
                  value={nickname}
                  onChange={handleNicknameChange}
                  className={nicknameError ? 'error-input' : ''}
                  required 
                />
                <small className="field-hint" style={{ color: nicknameError ? '#ff4444' : '' }}>
                  {nicknameError ? '‚ùå –≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è' : '–≠—Ç–æ –∏–º—è –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º'}
                </small>
              </div>
              
              <div className="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:</label>
                <div className="city-options">
                  <div 
                    className={`city-option moscow ${selectedCity === 'moscow' ? 'active' : ''}`}
                    onClick={() => handleCitySelect('moscow')}
                  >
                    <div className="city-name">–ú–æ—Å–∫–≤–∞</div>
                    <div className="city-description">–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –º–µ—Ç—Ä–æ–ø–æ–ª–∏—Ç–µ–Ω</div>
                  </div>
                  <div 
                    className={`city-option spb ${selectedCity === 'spb' ? 'active' : ''}`}
                    onClick={() => handleCitySelect('spb')}
                  >
                    <div className="city-name">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</div>
                    <div className="city-description">–ü–µ—Ç–µ—Ä–±—É—Ä–≥—Å–∫–∏–π –º–µ—Ç—Ä–æ–ø–æ–ª–∏—Ç–µ–Ω</div>
                  </div>
                </div>
              </div>
              
              <div className="form-group">
                <label>–í–∞—à –ø–æ–ª:</label>
                <div className="gender-options">
                  <div 
                    className={`gender-option ${selectedGender === 'male' ? 'active' : ''}`}
                    onClick={() => handleGenderSelect('male')}
                  >
                    –ú—É–∂—Å–∫–æ–π
                  </div>
                  <div 
                    className={`gender-option ${selectedGender === 'female' ? 'active' : ''}`}
                    onClick={() => handleGenderSelect('female')}
                  >
                    –ñ–µ–Ω—Å–∫–∏–π
                  </div>
                </div>
              </div>
              
              <button 
                type="button" 
                className="btn" 
                onClick={handleEnterWaitingRoom}
                disabled={isLoading || isSessionRestoring}
              >
                {isLoading ? '–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è...' : '–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É –æ–∂–∏–¥–∞–Ω–∏—è'}
              </button>
              
              {nicknameError && (
                <div style={{
                  marginTop: '10px',
                  padding: '10px',
                  backgroundColor: '#fff5f5',
                  border: '1px solid #ff4444',
                  borderRadius: '5px',
                  color: '#ff4444',
                  fontSize: '12px',
                  textAlign: 'center'
                }}>
                  ‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
                </div>
              )}
            </div>
          )}

          {currentScreen === 'waiting' && (
            <div id="waiting-room-screen" className="screen">
              <button className="back-btn" onClick={showSetup}>
                <i>‚Üê</i> –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
              </button>
              
              <h2>–ö–æ–º–Ω–∞—Ç–∞ –æ–∂–∏–¥–∞–Ω–∏—è</h2>
              <div className="navigation-buttons">
                <button className="nav-btn" onClick={showSetup}>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞</button>
                <button className="nav-btn active">2. –í—ã–±–æ—Ä —Å—Ç–∞–Ω—Ü–∏–∏</button>
                <button className="nav-btn" onClick={showJoinedRoom}>3. –ö–æ–º–Ω–∞—Ç–∞ —Å—Ç–∞–Ω—Ü–∏–∏</button>
              </div>
              
              <p style={{fontSize: '12px'}}> üî¥ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è </p>
              <p style={{fontSize: '12px'}}> üî¥ –¶–≤–µ—Ç –≤–µ—Ä—Ö–Ω–µ–π –æ–¥–µ–∂–¥—ã –∏–ª–∏ —Å—Ç–∏–ª—å </p>
              <p style={{fontSize: '12px'}}> üî¥ –ù–æ–º–µ—Ä –≤–∞–≥–æ–Ω–∞ (–µ—Å–ª–∏ –≤ –ø—É—Ç–∏)</p>
              
              <div className="stations-map-container">
                <h3>üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ</h3>
                
                <div className="map-legend">
                  <div className="legend-item">
                    <div className="legend-color connected"></div>
                    <span>–í—ã–±—Ä–∞–ª–∏ —Å—Ç–∞–Ω—Ü–∏—é: {stationsData.totalStats?.total_connected || 0}</span>
                  </div>
                  <div className="legend-item">
                    <div className="legend-color waiting"></div>
                    <span>–í —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è: {stationsData.totalStats?.total_waiting || 0}</span>
                  </div>
                </div>
                
                <div 
                  ref={metroMapRef}
                  className="metro-map" 
                  id="metro-map"
                >
                  {renderStationsMap()}
                </div>
                
                {stationError && (
                  <div style={{
                    marginTop: '10px',
                    padding: '8px',
                    backgroundColor: '#fff5f5',
                    border: '1px solid #ff4444',
                    borderRadius: '5px',
                    color: '#ff4444',
                    fontSize: '12px',
                    textAlign: 'center'
                  }}>
                    ‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ –≤—ã—à–µ
                  </div>
                )}
              </div>

              <div className="user-settings-panel">
                <h4>–í–∞—à–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                
                <div className="form-group">
                  <label htmlFor="wagon-select">–ù–æ–º–µ—Ä –≤–∞–≥–æ–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                  <select 
                    id="wagon-select" 
                    value={wagonNumber}
                    onChange={(e) => setWagonNumber(e.target.value)}
                  >
                    <option value="">–ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                  </select>
                </div>
                
                <div className="form-group">
                  <label htmlFor="color-select" style={{ color: clothingColorError ? '#ff4444' : '' }}>
                    –¶–≤–µ—Ç –≤–µ—Ä—Ö–Ω–µ–π –æ–¥–µ–∂–¥—ã –∏–ª–∏ —Å—Ç–∏–ª—å *
                    {clothingColorError && (
                      <span style={{ color: '#ff4444', marginLeft: '5px', fontSize: '12px' }}>
                        (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
                      </span>
                    )}
                  </label>
                  <input 
                    ref={clothingColorInputRef}
                    type="text" 
                    id="color-select" 
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —á–µ—Ä–Ω—ã–π –≤–µ—Ä—Ö, —Å–∏–Ω–∏–π –Ω–∏–∑, –æ—á–∫–∏, —à–∞–ø–∫–∞" 
                    value={clothingColor}
                    onChange={handleClothingColorChange}
                    required 
                  />
                  <small className="field-hint" style={{ color: clothingColorError ? '#ff4444' : '' }}>
                    {clothingColorError ? '‚ùå –≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è' : '–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è'}
                  </small>
                </div>
                
                {(clothingColorError || stationError) && (
                  <div style={{
                    marginTop: '15px',
                    padding: '10px',
                    backgroundColor: '#fff5f5',
                    border: '1px solid #ff4444',
                    borderRadius: '5px',
                    color: '#ff4444',
                    fontSize: '12px',
                    textAlign: 'center'
                  }}>
                    {clothingColorError && stationError ? (
                      '‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é'
                    ) : clothingColorError ? (
                      '‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ü–≤–µ—Ç –≤–µ—Ä—Ö–Ω–µ–π –æ–¥–µ–∂–¥—ã –∏–ª–∏ —Å—Ç–∏–ª—å'
                    ) : (
                      '‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ'
                    )}
                  </div>
                )}
                           
                <button 
                  className="btn btn-success" 
                  onClick={handleConfirmStation}
                  disabled={isLoading}
                >
                  {isLoading ? '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...' : '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è'}
                </button>
              </div>
            </div>
          )}

          {currentScreen === 'joined' && (
            <div id="joined-room-screen" className="screen">
              <button className="back-btn" onClick={handleLeaveGroup}>
                <i>‚Üê</i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–∏—Å–∫—É
              </button>
              
              <h2>–í—ã –≤—ã–±—Ä–∞–ª–∏ —Å—Ç–∞–Ω—Ü–∏—é {currentGroup?.station}</h2>
              <div className="navigation-buttons">
                <button className="nav-btn" onClick={showSetup}>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞</button>
                <button className="nav-btn" onClick={showWaitingRoom}>2. –í—ã–±–æ—Ä —Å—Ç–∞–Ω—Ü–∏–∏</button>
                <button className="nav-btn active">3. –ö–æ–º–Ω–∞—Ç–∞ —Å—Ç–∞–Ω—Ü–∏–∏</button>
              </div>
              
              <p>–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–≤–æ–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
              
              <div className="status-indicators" id="current-user-status">
                <div className="status-indicator" id="position-indicator">
                  üìç –ü–æ–∑–∏—Ü–∏—è: <span id="current-position">
                    {selectedPosition || '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞'}
                  </span>
                </div>
                <div className="status-indicator" id="mood-indicator">
                  üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: <span id="current-mood">
                    {selectedMood || '–Ω–µ –≤—ã–±—Ä–∞–Ω–æ'}
                  </span>
                </div>
              </div>
              
              <div className="state-section">
                <h4>üéØ –í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è –Ω–∞ —Å—Ç–∞–Ω—Ü–∏–∏ –∏–ª–∏ –≤ –≤–∞–≥–æ–Ω–µ</h4>
                <div className="state-cards" id="position-cards">
                  {[
                    { position: "–ë—Ä–æ–∂—É –ø–æ —Å—Ç–∞–Ω—Ü–∏–∏", icon: "üö∂" },
                    { position: "–°–∏–∂—É –Ω–∞ —Å—Ç–∞–Ω—Ü–∏–∏", icon: "üôã" },
                    { position: "–ò–¥—É –∫ –ø–æ–µ–∑–¥—É", icon: "üöÄ" },
                    { position: "–°—Ç–æ—é –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤ –≤–∞–≥–æ–Ω–µ", icon: "üßç" },
                    { position: "–°—Ç–æ—é —É –¥–≤–µ—Ä–∏ –≤ –≤–∞–≥–æ–Ω–µ", icon: "üö™" },
                    { position: "–°–∏–∂—É –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤ –≤–∞–≥–æ–Ω–µ", icon: "üí∫" },
                    { position: "–°–∏–∂—É —É –¥–≤–µ—Ä–∏ –≤ –≤–∞–≥–æ–Ω–µ", icon: "ü™ë" },
                    { position: "–°–∏–∂—É —á–∏—Ç–∞—é –≤ –≤–∞–≥–æ–Ω–µ", icon: "üìñ" }
                  ].map((item) => (
                    <div 
                      key={item.position}
                      className={`state-card ${selectedPosition === item.position ? 'active' : ''}`}
                      onClick={() => handlePositionSelect(item.position)}
                    >
                      <div className="state-icon">{item.icon}</div>
                      <div className="state-name">{item.position}</div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="state-section">
                <h4>üòä –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h4>
                <div className="state-cards" id="mood-cards">
                  {[
                    { mood: "–ü—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞—é", icon: "üëÄ" },
                    { mood: "–°–ø–ª—é", icon: "üò¥" },
                    { mood: "–•–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —É–ª—ã–±–∞—é—Å—å", icon: "üòä" },
                    { mood: "–ü–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –≥—Ä—É—Å—Ç–Ω–æ", icon: "üòî" },
                    { mood: "–ñ–¥—É –∫–æ–≥–¥–∞ –∫–æ –º–Ω–µ –ø–æ–¥–æ–π–¥—É—Ç", icon: "‚è≥" },
                    { mood: "–°–æ–±–∏—Ä–∞—é—Å—å –ø–æ–¥–æ–π—Ç–∏", icon: "üö∂" }
                  ].map((item) => (
                    <div 
                      key={item.mood}
                      className={`state-card ${selectedMood === item.mood ? 'active' : ''}`}
                      onClick={() => handleMoodSelect(item.mood)}
                    >
                      <div className="state-icon">{item.icon}</div>
                      <div className="state-name">{item.mood}</div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="users-list-section">
                <h3>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–∞ –≤–∞—à–µ–π —Å—Ç–∞–Ω—Ü–∏–∏</h3>
                <div id="group-members">
                  {renderGroupMembers()}
                </div>
              </div>
              
              <button className="btn btn-danger" onClick={handleLeaveGroup}>
                –ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É
              </button>
            </div>
          )}
        </div>
        
        <footer>
          &copy; 2026 | –ì–∞–¥–∂–∏ –õ–∞—Ç–∏–ø–æ–≤ | –ú–µ—Ç—Ä–æ—Å | –°–∞–Ω–∫—Ç –ü–µ—Ç–µ—Ä–±—É—Ä–≥
        </footer>
      </div>
    </div>
  );
};